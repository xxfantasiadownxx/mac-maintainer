#!/bin/bash

# update_all - Automated macOS Update Script for Multiple Machines
# This script SSHs into each machine, deploys the update script, and executes it

set -e  # Exit on error (will be trapped)

# File paths
IP_FILE="ipaddresses.txt"
CREDS_FILE="credentials.json"
UPDATE_OS_FILE="update_os"
ERROR_LOG="error_log.txt"
REMOTE_SCRIPT="prune_and_update"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to log errors
log_error() {
    local ip=$1
    local error=$2
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] IP: $ip - ERROR: $error" >> "$ERROR_LOG"
    echo -e "${RED}[ERROR]${NC} $ip - $error"
}

# Function to log success
log_success() {
    local ip=$1
    echo -e "${GREEN}[SUCCESS]${NC} $ip - Update completed successfully"
}

# Function to log info
log_info() {
    local ip=$1
    local msg=$2
    echo -e "${YELLOW}[INFO]${NC} $ip - $msg"
}

# Check if required files exist
if [[ ! -f "$IP_FILE" ]]; then
    echo -e "${RED}Error: $IP_FILE not found!${NC}"
    exit 1
fi

if [[ ! -f "$CREDS_FILE" ]]; then
    echo -e "${RED}Error: $CREDS_FILE not found!${NC}"
    exit 1
fi

if [[ ! -f "$UPDATE_OS_FILE" ]]; then
    echo -e "${RED}Error: $UPDATE_OS_FILE not found!${NC}"
    exit 1
fi

# Check if expect is installed (should be pre-installed on macOS)
if ! command -v expect &> /dev/null; then
    echo -e "${RED}Error: expect not found. This should be pre-installed on macOS.${NC}"
    exit 1
fi

# Parse credentials from JSON
USERNAME=$(grep -o '"username"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDS_FILE" | sed 's/.*"username"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
PASSWORD=$(grep -o '"password"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDS_FILE" | sed 's/.*"password"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

if [[ -z "$USERNAME" ]] || [[ -z "$PASSWORD" ]]; then
    echo -e "${RED}Error: Could not parse credentials from $CREDS_FILE${NC}"
    echo "Expected format: {\"username\": \"your_user\", \"password\": \"your_pass\"}"
    exit 1
fi

# Initialize error log
echo "=== Update Session Started: $(date) ===" >> "$ERROR_LOG"

# Read the update_os script content
UPDATE_SCRIPT_CONTENT=$(cat "$UPDATE_OS_FILE")

# Modify the script to remove interactive prompts for automated execution
AUTOMATED_SCRIPT=$(echo "$UPDATE_SCRIPT_CONTENT" | sed -e 's/read -p .* confirm/confirm="yes"/g' -e 's/read -p .* update_confirm/update_confirm="yes"/g')

echo ""
echo "=========================================="
echo "  Automated macOS Update Process"
echo "=========================================="
echo ""
echo "Starting update process for machines listed in $IP_FILE"
echo "Credentials: $USERNAME"
echo "Error log: $ERROR_LOG"
echo ""

# Counter for statistics
total=0
successful=0
failed=0

# Process each IP address
while IFS= read -r ip || [[ -n "$ip" ]]; do
    # Skip empty lines and comments
    [[ -z "$ip" ]] && continue
    [[ "$ip" =~ ^# ]] && continue
    
    total=$((total + 1))
    
    echo ""
    echo "=========================================="
    echo "Processing: $ip ($total)"
    echo "=========================================="
    
    # Test if host is reachable
    log_info "$ip" "Testing connection..."
    if ! ping -c 2 -W 3 "$ip" &>/dev/null; then
        log_error "$ip" "Host unreachable (ping failed)"
        failed=$((failed + 1))
        continue
    fi
    
    # Test SSH connection using expect
    log_info "$ip" "Attempting SSH connection..."
    ssh_test=$(expect -c "
        set timeout 10
        spawn ssh -o StrictHostKeyChecking=no $USERNAME@$ip echo 'Connection test'
        expect {
            \"password:\" {
                send \"$PASSWORD\r\"
                expect {
                    \"Connection test\" { exit 0 }
                    timeout { exit 1 }
                }
            }
            timeout { exit 1 }
        }
    " 2>&1)
    
    if [[ $? -ne 0 ]]; then
        log_error "$ip" "SSH connection failed"
        failed=$((failed + 1))
        continue
    fi
    
    log_info "$ip" "Connected successfully"
    
    # Create the script on remote machine using expect
    log_info "$ip" "Deploying update script..."
    deploy_result=$(expect -c "
        set timeout 30
        spawn ssh -o StrictHostKeyChecking=no $USERNAME@$ip
        expect {
            \"password:\" {
                send \"$PASSWORD\r\"
                expect \"$\" {
                    send \"cat > $REMOTE_SCRIPT << 'EOFSCRIPT'\r\"
                    send \"$AUTOMATED_SCRIPT\r\"
                    send \"EOFSCRIPT\r\"
                    expect \"$\"
                    send \"exit\r\"
                }
            }
            timeout { exit 1 }
        }
        expect eof
    " 2>&1)
    
    if [[ $? -ne 0 ]]; then
        log_error "$ip" "Failed to create remote script"
        failed=$((failed + 1))
        continue
    fi
    
    # Make script executable using expect
    log_info "$ip" "Setting executable permissions..."
    chmod_result=$(expect -c "
        set timeout 30
        spawn ssh -o StrictHostKeyChecking=no $USERNAME@$ip
        expect {
            \"password:\" {
                send \"$PASSWORD\r\"
                expect \"$\" {
                    send \"echo '$PASSWORD' | sudo -S chmod +x $REMOTE_SCRIPT\r\"
                    expect {
                        \"incorrect password\" { exit 2 }
                        \"authentication failure\" { exit 2 }
                        \"$\" { 
                            send \"exit\r\"
                            exit 0 
                        }
                    }
                }
            }
            timeout { exit 1 }
        }
        expect eof
    " 2>&1)
    
    if [[ $? -eq 2 ]]; then
        log_error "$ip" "Failed to authenticate for chmod"
        failed=$((failed + 1))
        continue
    elif [[ $? -ne 0 ]]; then
        log_error "$ip" "Failed to set permissions"
        failed=$((failed + 1))
        continue
    fi
    
    # Execute the update script using expect
    log_info "$ip" "Executing update script (this may take a while)..."
    
    exec_result=$(expect -c "
        set timeout -1
        spawn ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 $USERNAME@$ip
        expect {
            \"password:\" {
                send \"$PASSWORD\r\"
                expect \"$\" {
                    send \"echo '$PASSWORD' | sudo -S bash ./$REMOTE_SCRIPT\r\"
                    expect {
                        \"incorrect password\" { exit 2 }
                        \"authentication failure\" { exit 2 }
                        \"Failed to authenticate\" { exit 2 }
                        eof { exit 0 }
                    }
                }
            }
            timeout { exit 1 }
        }
    " 2>&1)
    
    # Check for authentication failure
    if [[ $? -eq 2 ]] || echo "$exec_result" | grep -qi "failed to authenticate\|authentication failure\|incorrect password"; then
        log_error "$ip" "Failed to authenticate during script execution"
        failed=$((failed + 1))
        continue
    fi
    
    # If we get here, assume success (machine may have rebooted)
    log_success "$ip"
    successful=$((successful + 1))
    
    # Brief pause before next machine
    sleep 3
    
done < "$IP_FILE"

# Final summary
echo ""
echo "=========================================="
echo "  Update Process Complete"
echo "=========================================="
echo ""
echo "Total machines: $total"
echo -e "${GREEN}Successful: $successful${NC}"
echo -e "${RED}Failed: $failed${NC}"
echo ""
echo "Check $ERROR_LOG for details on any failures."
echo ""
echo "=== Update Session Ended: $(date) ===" >> "$ERROR_LOG"
