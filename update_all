#!/bin/bash

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IP_LIST="$SCRIPT_DIR/ipaddresses.txt"
CREDENTIALS="$SCRIPT_DIR/credentials.json"
ERROR_LOG="$SCRIPT_DIR/error_log.txt"

# Check if required files exist
if [ ! -f "$IP_LIST" ]; then
    echo "Error: ipaddresses.txt not found!"
    exit 1
fi

if [ ! -f "$CREDENTIALS" ]; then
    echo "Error: credentials.json not found!"
    exit 1
fi

# Parse credentials from JSON
USERNAME=$(grep -o '"username"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDENTIALS" | sed 's/.*"username"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
PASSWORD=$(grep -o '"password"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDENTIALS" | sed 's/.*"password"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
PORT=$(grep -o '"port"[[:space:]]*:[[:space:]]*[0-9]*' "$CREDENTIALS" | sed 's/.*"port"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/')

# Default port if not specified
if [ -z "$PORT" ]; then
    PORT=22
fi

echo "=========================================="
echo "Starting mass update process"
echo "Time: $(date)"
echo "=========================================="

# Process each IP address
while IFS= read -r IP || [ -n "$IP" ]; do
    # Skip empty lines
    [ -z "$IP" ] && continue
    
    echo ""
    echo "Processing: $IP"
    echo "------------------------------------------"
    
    # Test if host is reachable
    if ! ping -c 1 -W 2 "$IP" &> /dev/null; then
        echo "ERROR: $IP is not reachable"
        echo "[$(date)] $IP - Host unreachable" >> "$ERROR_LOG"
        continue
    fi
    
    # SSH and run update script using expect
    /usr/bin/expect -c "
        set timeout 300
        log_user 1
        
        spawn ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p $PORT $USERNAME@$IP
        
        expect {
            -re \"password:|Password:\" {
                send \"$PASSWORD\r\"
                expect {
                    -re \"Permission denied|Failed to authenticate\" {
                        puts \"AUTH_FAILED\"
                        exit 1
                    }
                    -re \"\\\\$|#|%|>\" {
                        # Logged in successfully
                    }
                    timeout {
                        puts \"LOGIN_TIMEOUT\"
                        exit 1
                    }
                }
            }
            -re \"Permission denied\" {
                puts \"AUTH_FAILED\"
                exit 1
            }
            timeout {
                puts \"CONNECTION_TIMEOUT\"
                exit 1
            }
        }
        
        # Send the inline update script using a different approach
        send \"cat > /tmp/update_script_$.sh << 'HEREDOC_END'\r\"
        send \"#!/bin/bash\r\"
        send \"echo '================================'\r\"
        send \"echo 'STEP 1: Pruning Inactive Users'\r\"
        send \"echo '================================'\r\"
        send \"echo ''\r\"
        send \"\r\"
        send \"EXCLUDE_USERS=(\\\"Atlas\\\" \\\"berklgre\\\" \\\"daemon\\\" \\\"nobody\\\" \\\"root\\\" \\\"Support\\\")\r\"
        send \"THIRTY_DAYS_AGO=\\$(date -v-30d +%s)\r\"
        send \"TEMP_FILE=\\$(mktemp)\r\"
        send \"\r\"
        send \"while read user; do\r\"
        send \"  if \[\[ \\\" \\${EXCLUDE_USERS\[\\@\]} \\\" =~ \\\" \\${user} \\\" \]\]; then\r\"
        send \"    continue\r\"
        send \"  fi\r\"
        send \"  last_login=\\$(last -1 \\\"\\$user\\\" | head -1 | grep -v 'wtmp begins')\r\"
        send \"  if \[\[ -z \\\"\\$last_login\\\" \]\]; then\r\"
        send \"    echo \\\"Will delete: \\$user - Never logged in\\\"\r\"
        send \"    echo \\\"\\$user\\\" >> \\\"\\$TEMP_FILE\\\"\r\"
        send \"    continue\r\"
        send \"  fi\r\"
        send \"  login_date=\\$(echo \\\"\\$last_login\\\" | awk '{print \\$4, \\$5, \\$6}')\r\"
        send \"  if echo \\\"\\$last_login\\\" | grep -q \\\"still logged in\\\"; then\r\"
        send \"    continue\r\"
        send \"  fi\r\"
        send \"  login_epoch=\\$(date -j -f \\\"%b %d %H:%M\\\" \\\"\\$login_date\\\" +%s 2>/dev/null)\r\"
        send \"  if \[\[ -z \\\"\\$login_epoch\\\" \]\]; then\r\"
        send \"    continue\r\"
        send \"  fi\r\"
        send \"  if \[\[ \\$login_epoch -lt \\$THIRTY_DAYS_AGO \]\]; then\r\"
        send \"    echo \\\"Will delete: \\$user - Last login: \\$login_date\\\"\r\"
        send \"    echo \\\"\\$user\\\" >> \\\"\\$TEMP_FILE\\\"\r\"
        send \"  fi\r\"
        send \"done < <(dscl . list /Users | grep -v '^_')\r\"
        send \"\r\"
        send \"echo ''\r\"
        send \"echo 'Users to be deleted:'\r\"
        send \"echo '--------------------'\r\"
        send \"\r\"
        send \"if \[\[ -s \\\"\\$TEMP_FILE\\\" \]\]; then\r\"
        send \"  cat \\\"\\$TEMP_FILE\\\" | while read user; do\r\"
        send \"    echo \\\"  - \\$user\\\"\r\"
        send \"  done\r\"
        send \"  echo ''\r\"
        send \"  echo 'Auto-deleting users...'\r\"
        send \"  while read user; do\r\"
        send \"    echo \\\"Deleting user: \\$user\\\"\r\"
        send \"    sudo sysadminctl -deleteUser \\\"\\$user\\\"\r\"
        send \"  done < \\\"\\$TEMP_FILE\\\"\r\"
        send \"  echo 'User deletion complete!'\r\"
        send \"else\r\"
        send \"  echo '  (No users to delete)'\r\"
        send \"fi\r\"
        send \"\r\"
        send \"rm \\\"\\$TEMP_FILE\\\"\r\"
        send \"\r\"
        send \"echo ''\r\"
        send \"echo '================================'\r\"
        send \"echo 'STEP 2: Checking for macOS Updates'\r\"
        send \"echo '================================'\r\"
        send \"echo ''\r\"
        send \"\r\"
        send \"echo 'Searching for available software updates...'\r\"
        send \"UPDATE_OUTPUT=\\$(softwareupdate -l 2>&1)\r\"
        send \"UPDATE_LABEL=\\$(echo \\\"\\$UPDATE_OUTPUT\\\" | grep \\\"^\\\\* Label:\\\" | head -1 | sed 's/^\\\\* Label: //')\r\"
        send \"\r\"
        send \"if \[\[ -z \\\"\\$UPDATE_LABEL\\\" \]\]; then\r\"
        send \"  echo 'No macOS updates found.'\r\"
        send \"  echo ''\r\"
        send \"  echo \\\"\\$UPDATE_OUTPUT\\\"\r\"
        send \"else\r\"
        send \"  echo \\\"Found update: \\$UPDATE_LABEL\\\"\r\"
        send \"  echo ''\r\"
        send \"  echo 'Auto-installing update and restarting...'\r\"
        send \"  sudo softwareupdate -i \\\"\\$UPDATE_LABEL\\\" --restart\r\"
        send \"fi\r\"
        send \"\r\"
        send \"echo ''\r\"
        send \"echo 'Script complete!'\r\"
        send \"HEREDOC_END\r\"
        send \"chmod +x /tmp/update_script_$.sh\r\"
        send \"bash /tmp/update_script_$.sh\r\"
        send \"rm /tmp/update_script_$.sh\r\"
        
        # Wait for script completion or reboot
        expect {
            -re \"Script complete!\" {
                send \"exit\r\"
                expect eof
                exit 0
            }
            eof {
                exit 0
            }
            timeout {
                exit 0
            }
        }
    "
    
    EXIT_CODE=$?
    
    # Check exit code and handle errors
    if [ $EXIT_CODE -eq 1 ]; then
        echo "ERROR: Authentication or connection failed for $IP"
        echo "[$(date)] $IP - Failed to authenticate" >> "$ERROR_LOG"
        continue
    fi
    
    if [ $EXIT_CODE -ne 0 ]; then
        echo "ERROR: SSH command failed for $IP"
        echo "[$(date)] $IP - SSH command failed" >> "$ERROR_LOG"
        continue
    fi
    
    echo "SUCCESS: $IP processed successfully"
    
    # Brief pause before next host
    sleep 5
    
done < "$IP_LIST"

echo ""
echo "=========================================="
echo "Mass update process completed"
echo "Time: $(date)"
echo "Check $ERROR_LOG for any errors"
echo "=========================================="
