#!/bin/bash

# update_all - Automated macOS Update Script for Multiple Machines
# This script SSHs into each machine, deploys the update script, and executes it

set -e  # Exit on error (will be trapped)

# File paths
IP_FILE="ipaddresses.txt"
CREDS_FILE="credentials.json"
UPDATE_OS_FILE="update_os"
ERROR_LOG="error_log.txt"
REMOTE_SCRIPT="prune_and_update"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to log errors
log_error() {
    local ip=$1
    local error=$2
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] IP: $ip - ERROR: $error" >> "$ERROR_LOG"
    echo -e "${RED}[ERROR]${NC} $ip - $error"
}

# Function to log success
log_success() {
    local ip=$1
    echo -e "${GREEN}[SUCCESS]${NC} $ip - Update completed successfully"
}

# Function to log info
log_info() {
    local ip=$1
    local msg=$2
    echo -e "${YELLOW}[INFO]${NC} $ip - $msg"
}

# Check if required files exist
if [[ ! -f "$IP_FILE" ]]; then
    echo -e "${RED}Error: $IP_FILE not found!${NC}"
    exit 1
fi

if [[ ! -f "$CREDS_FILE" ]]; then
    echo -e "${RED}Error: $CREDS_FILE not found!${NC}"
    exit 1
fi

if [[ ! -f "$UPDATE_OS_FILE" ]]; then
    echo -e "${RED}Error: $UPDATE_OS_FILE not found!${NC}"
    exit 1
fi

# Check if sshpass is installed (needed for automated password entry)
if ! command -v sshpass &> /dev/null; then
    echo -e "${YELLOW}sshpass not found. Installing via Homebrew...${NC}"
    if ! command -v brew &> /dev/null; then
        echo -e "${RED}Error: Homebrew not installed. Please install Homebrew first.${NC}"
        echo "Visit: https://brew.sh"
        exit 1
    fi
    brew install sshpass
fi

# Parse credentials from JSON
USERNAME=$(grep -o '"username"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDS_FILE" | sed 's/.*"username"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
PASSWORD=$(grep -o '"password"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDS_FILE" | sed 's/.*"password"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')

if [[ -z "$USERNAME" ]] || [[ -z "$PASSWORD" ]]; then
    echo -e "${RED}Error: Could not parse credentials from $CREDS_FILE${NC}"
    echo "Expected format: {\"username\": \"your_user\", \"password\": \"your_pass\"}"
    exit 1
fi

# Initialize error log
echo "=== Update Session Started: $(date) ===" >> "$ERROR_LOG"

# Read the update_os script content
UPDATE_SCRIPT_CONTENT=$(cat "$UPDATE_OS_FILE")

# Modify the script to remove interactive prompts for automated execution
AUTOMATED_SCRIPT=$(echo "$UPDATE_SCRIPT_CONTENT" | sed -e 's/read -p .* confirm/confirm="yes"/g' -e 's/read -p .* update_confirm/update_confirm="yes"/g')

echo ""
echo "=========================================="
echo "  Automated macOS Update Process"
echo "=========================================="
echo ""
echo "Starting update process for machines listed in $IP_FILE"
echo "Credentials: $USERNAME"
echo "Error log: $ERROR_LOG"
echo ""

# Counter for statistics
total=0
successful=0
failed=0

# Process each IP address
while IFS= read -r ip || [[ -n "$ip" ]]; do
    # Skip empty lines and comments
    [[ -z "$ip" ]] && continue
    [[ "$ip" =~ ^# ]] && continue
    
    total=$((total + 1))
    
    echo ""
    echo "=========================================="
    echo "Processing: $ip ($total)"
    echo "=========================================="
    
    # Test if host is reachable
    log_info "$ip" "Testing connection..."
    if ! ping -c 2 -W 3 "$ip" &>/dev/null; then
        log_error "$ip" "Host unreachable (ping failed)"
        failed=$((failed + 1))
        continue
    fi
    
    # Test SSH connection
    log_info "$ip" "Attempting SSH connection..."
    if ! sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=no "$USERNAME@$ip" "echo 'Connection test'" &>/dev/null; then
        log_error "$ip" "SSH connection failed"
        failed=$((failed + 1))
        continue
    fi
    
    log_info "$ip" "Connected successfully"
    
    # Create the script on remote machine
    log_info "$ip" "Deploying update script..."
    if ! echo "$AUTOMATED_SCRIPT" | sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no "$USERNAME@$ip" "cat > $REMOTE_SCRIPT"; then
        log_error "$ip" "Failed to create remote script"
        failed=$((failed + 1))
        continue
    fi
    
    # Make script executable
    log_info "$ip" "Setting executable permissions..."
    if ! sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no "$USERNAME@$ip" "echo '$PASSWORD' | sudo -S chmod +x $REMOTE_SCRIPT" 2>&1 | grep -qi "authentication failure\|incorrect password"; then
        :
    else
        log_error "$ip" "Failed to authenticate for chmod"
        failed=$((failed + 1))
        continue
    fi
    
    # Execute the update script
    log_info "$ip" "Executing update script (this may take a while)..."
    
    # Run the script and capture output, checking for authentication failures
    exec_output=$(sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 "$USERNAME@$ip" "echo '$PASSWORD' | sudo -S bash ./$REMOTE_SCRIPT" 2>&1 || true)
    
    # Check for authentication failure
    if echo "$exec_output" | grep -qi "failed to authenticate\|authentication failure\|incorrect password"; then
        log_error "$ip" "Failed to authenticate during script execution"
        failed=$((failed + 1))
        continue
    fi
    
    # If we get here, assume success (machine may have rebooted)
    log_success "$ip"
    successful=$((successful + 1))
    
    # Brief pause before next machine
    sleep 3
    
done < "$IP_FILE"

# Final summary
echo ""
echo "=========================================="
echo "  Update Process Complete"
echo "=========================================="
echo ""
echo "Total machines: $total"
echo -e "${GREEN}Successful: $successful${NC}"
echo -e "${RED}Failed: $failed${NC}"
echo ""
echo "Check $ERROR_LOG for details on any failures."
echo ""
echo "=== Update Session Ended: $(date) ===" >> "$ERROR_LOG"
